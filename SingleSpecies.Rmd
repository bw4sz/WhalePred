---
title: "Antarctic Whale Project: Single Species"
author: "Ben Weinstein"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    keep_md: true
    number_sections: true
    toc: true
    theme: spacelab
---

```{r,warning=FALSE,message=FALSE,echo=FALSE}
library(knitr)
opts_chunk$set(echo=F,warning=F,message=F,fig.width = 10,fig.height = 5)
library(boot)
library(raster)
library(reshape2)
library(ggplot2)
library(MASS)
library(ggmap)
library(dplyr)
library(chron)
library(gridExtra)
library(stringr)
library(R2jags)
library(move)

#New model to be run, flag turned off if just updating.
newModel<-TRUE
```

```{r,eval=F}
#Load in data
load("SingleSpecies.RData")
jags$recompile()
newModel<-F
```

#Abstract

We are currently ignoring any observation process or time regularization.

```{r}
mdat<-read.csv("InputData/FullData-550793189439001813.csv")

##need to look into making into a movebank object.

#Create a oceandepth in km 
mdat$ocean<-mdat$ETOPO1.Elevation*-1 / 1000

#standardize column names to match the simulation
#Create an animal tag.
mxy <- as(mdat, "data.frame")
mxy$Animal<-mxy$individual.local.identifier
mxy$x<-mxy$location.long
mxy$y<-mxy$location.lat

#give steps, this will need to be discretized.
#merge with input
sxy<-split(mxy,mxy$Animal)
sxy<-lapply(sxy,function(x){
  x$Step<-1:nrow(x)
  return(x)
})
mxy<-rbind_all(sxy)

#grab three individuals
mxy<-mxy[mxy$Animal %in% c('131133','131120','131118'),]
mxy$Animal<-as.numeric(as.factor(mxy$Animal))


#Plot
pp<-c(mean(mxy$x),mean(mxy$y))
m <- get_map(location=pp,source="google",zoom=6,scale=2,maptype="satellite")
ggmap(m)+geom_path(data=mxy, aes(x=x, y=y,col=as.factor(Animal)),size=.5) + labs(col="Whale")
```

```{r,eval=F}
#Load in data
load("MultiSpecies.RData")
jags$recompile()
newModel<-F
```

#Abstract


#Movement model

Dynamic correlation random walk following Jonsen (2005) and Jonsen (2016).

*Process Model*

$$ d_{t} \sim T*d_{t-1} + Normal(0,\Sigma)$$
$$ x_t = x_{t-1} + d_{t} $$

## Parameters

$$\theta = \text{Mean turning angle}$$
$$\gamma = \text{Move persistence} $$

###Behavioral States

$$ Behavior_1 = \text{traveling}$$
$$ Behavior_2 = \text{foraging}$$

$$ \alpha_{1,1} = \text{Probability of remaining traveling when traveling}$$
$$\alpha_{2,1} = \text{Probability of switching from feeding to traveling}$$

$$\begin{matrix}
  \alpha_{1,1} & 1-\alpha_{1,1} \\
  \alpha_{2,1} & 1-\alpha_{2,1} \\
\end{matrix}
$$

###Environment

Behavioral states are a function of local environmental conditions. Here I use ocean depth as a first covariate.

It generally follows the form, conditional on behavior at t -1:

$$Behavior_t \sim Multinomial([\phi_{traveling},\phi_{foraging}])$$
$$logit(\phi_{traveling}) = \alpha_{Behavior_{t-1}} + \beta_1 * Ocean_{y[t,]}$$
$$logit(\phi_{foraging}) = \alpha_{Behavior_{t-1}} + \beta_2 * Ocean_{y[t,]}$$



```{r,fig.height=3,fig.width=3.5}
dplot<-function(a1,beta,x){
  y<-inv.logit(a1[1]+beta[1]*x)
  d11<-data.frame(x,y,State="Traveling",Begin="Traveling")
  
  y<-1-inv.logit(a1[1]+beta[1]*x)
  d12<-data.frame(x,y,State="Feeding",Begin="Traveling")

  y<-inv.logit(a1[2]+beta[2]*x)
  d21<-data.frame(x,y,State="Traveling",Begin="Feeding")
  
  y<-1-inv.logit(a1[2]+beta[2]*x)
  d22<-data.frame(x,y,State="Feeding",Begin="Feeding")
  
  d<-rbind_all(list(d11,d12,d21,d22))
}
```

#Model Fitting

The goal of the model is to capture the true parameter we simulated above. As we increase complexity, we will be able to monitor the validity of our approach.

```{r,eval=T}
#source model
source("Bayesian/MultiSpecies.R")

#print model
print.noquote(readLines("Bayesian/MultiSpecies.R"))

#prior shape
R <- diag(c(1,1))

#steps 
steps<-as.numeric(table(mxy$Animal))

#make ocean a matrix
oc<-acast(mxy,Animal~Step,value.var="ocean")

#Individuals
ind=max(mxy$Animal)

#obs array
obs<-melt(mxy,measure.vars=c("x","y"))
obs<-acast(obs,Animal~Step~variable)

data=list(y=obs,steps=steps,R=R,ocean=oc,ind=ind)
#paramters to track
pt<-c("theta","gamma","alpha","beta","phi")

if(newModel){
  system.time(jagM<-jags.parallel(model.file = "Bayesian/Multi_RW.jags",data=data,n.chains=2,parameters.to.save=pt,n.iter=1000,n.burnin=800,n.thin=1,DIC=FALSE))
}
```

##Chains
```{r,fig.height=10}
#bind chains
pc<-melt(jagM$BUGSoutput$sims.array)
colnames(pc)<-c("Draw","chain","par","value")

#extract parameter name
pc$parameter<-data.frame(str_match(pc$par,"(\\w+)"))[,-1]

#Extract index
splitpc<-split(pc,pc$parameter)

#single index
splitpc[c("alpha","beta","gamma","theta")]<-lapply(splitpc[c("alpha","beta","gamma","theta")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,Behavior=sv)
    return(pc)
})

#Double index
#none

#Triple Index 
splitpc[c("phi")]<-lapply(splitpc[c("phi")],function(x){
#As matrices
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+),(\\d+),(\\d+)]"))[,3:5]
    colnames(sv)<-c("Animal","step","Behavior")
    pc<-data.frame(x,sv)
})

#bind all matrices back together
pc<-rbind_all(splitpc)
rm(splitpc)

#plot all but d
ggplot(pc[!pc$parameter %in% c("phi"),],aes(x=Draw,y=value)) + facet_wrap(~par,scales="free",ncol=2) + geom_line(aes(col=as.factor(chain))) + labs(col="Chain")
```

##Posteriors
```{r}
ggplot(data=pc[!pc$parameter %in% c("phi"),],aes(x=value)) + geom_histogram() + facet_wrap(~par,scales='free',ncol=4) + theme_bw() 

#plot phi
ggplot(pc[pc$parameter %in% "phi",]) + geom_histogram(aes(x=value,fill=Behavior),alpha=0.7) + theme_bw()
```

###Compare to priors

```{r}
#add comparison to priors
todraw<-table(pc$par)[1]
pc$Estimate<-"Posterior"

#add priors
#alpha
a1prior<-data.frame(Draw=1:todraw,par='alpha[1]',value=inv.logit(rnorm(todraw,0,1.6)),parameter='alpha',Behavior=1,Estimate="Prior")

a2prior<-data.frame(Draw=1:todraw,par='alpha[2]',value=inv.logit(rnorm(todraw,0,1.6)),parameter='alpha',Behavior=2,Estimate="Prior")

beta1prior<-data.frame(Draw=1:todraw,par='beta[1]',value=inv.logit(rnorm(todraw,0,1.6)),parameter='beta',Behavior=1,Estimate="Prior")

beta2prior<-data.frame(Draw=1:todraw,par='beta[2]',value=inv.logit(rnorm(todraw,0,1.6)),parameter='beta',Behavior=2,Estimate="Prior")

gamma1prior<-data.frame(Draw=1:todraw,par='gamma[1]',value=rbeta(todraw,5,2),parameter='gamma',Behavior=1,Estimate="Prior")

gamma2prior<-data.frame(Draw=1:todraw,par='gamma[2]',value=rbeta(todraw,2,5),parameter='gamma',Behavior=2,Estimate="Prior")

prs<-rbind_all(list(a1prior,a2prior,beta1prior,beta2prior,gamma1prior,gamma2prior))

prs$Behavior<-as.factor(prs$Behavior)

allp<-rbind_all(list(pc[!pc$parameter %in% c("phi"),],prs))

ggplot(allp,aes(x=Behavior,y=value,fill=Estimate)) + geom_violin() + facet_wrap(~parameter,scale="free")
```

##Prediction - environmental function

```{r}
alphap<-cbind(pc %>% filter(par=='alpha[1]') %>% .$value,pc %>% filter(par=='alpha[2]') %>% .$value)

betap<-cbind(pc %>% filter(par=='beta[1]') %>% .$value,pc %>% filter(par=='beta[2]') %>% .$value)
 
postplot<-list()

for(j in 1:nrow(alphap)){
  postplot[[j]]<-data.frame(dplot(x=mxy$ocean,a1=logit(alphap[j,]),beta=logit(betap[j,])),Iteration=j)
  }

postplot<-rbind_all(postplot)

dsum<-postplot %>% group_by(x,Begin,State) %>% summarize(y_mean=mean(y),lower=quantile(y,0.05),upper=quantile(y,0.95))

ggplot(dsum[,]) + geom_ribbon(aes(x=x,y=y_mean,ymin=upper,ymax=lower,fill=State),alpha=0.5) + theme_bw() + labs(col="Transition",x="Ocean Depth (km)",y="Probability",fill="Transition") + facet_wrap(~Begin) 

#overla
```

#Behavioral Prediction

```{r}
#We just need Feeding behavior
behav_chains<-pc[pc$Behavior == 2 & pc$parameter %in% "phi",]

#arrange by step - capitalize
behav_chains$Step<-as.numeric(as.character(behav_chains$step))
behav_chains<-behav_chains %>% arrange(Step)

#Label Behaviors
behav_chains$Behavior<-as.factor(behav_chains$Behavior)
levels(behav_chains$Behavior)<-c("Traveling","Feeding")

#average phi
mean_phi<-behav_chains %>% group_by(Animal,Step) %>% summarize(phi=mean(value))

#drop phi incase its already there from previous run
mxy$phi<-NULL

#merge
mxy<-merge(mxy,mean_phi,by=c("Step","Animal"))

#for each individual
sxy<-split(mxy,mxy$Animal)

sfeed<-lapply(sxy,function(j){
  #Plot
  pp<-c(mean(j$x),mean(j$y))
  m <- get_map(location=pp,source="google",zoom=7,scale=2,maptype="satellite")
  pl<-ggmap(m)+geom_path(data=j, aes(x=x, y=y,col=phi,group=Animal),size=.5) + scale_color_continuous(low='blue',high='red') + labs(col="Probability of Feeding")
  return(pl)
})

sfeed

#phi and ocean plot
ggplot(data=mxy,aes(x=ocean,y=logit(phi))) + geom_point() + labs(x="Ocean Depth",y="Estimated Log Odds of Feeding")
```

##Autocorrelation in behavior

```{r}
ggplot(data=mxy,aes(x=as.numeric(Step),y=phi,col=ocean)) + geom_line(aes(group=Animal),size=2) + labs("Probability of Feeding") + theme_bw() + scale_color_continuous(low='light blue',high='black') + labs(x="Time Step",y="Liklihood of Feeding")
```

```{r}
save.image("SingleSpecies.RData")
```
