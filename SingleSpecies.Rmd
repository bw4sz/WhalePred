---
title: "Antarctic Whale Project: Single Species"
author: "Ben Weinstein"
date: "`r Sys.time()`"
output: 
  html_document:
    keep_md: true
    number_sections: true
    toc: true
    theme: spacelab
---

```{r,warning=FALSE,message=FALSE,echo=FALSE}
library(knitr)
opts_chunk$set(echo=F,warning=F,message=F,fig.width = 11,fig.height = 5)
library(boot)
library(raster)
library(reshape2)
library(ggplot2)
library(survival)
library(MASS)
library(ggmap)
library(dplyr)
library(chron)
library(gridExtra)
library(stringr)
library(R2jags)
library(move)

#New model to be run, flag turned off if just updating.
newModel<-T
```

```{r,eval=F}
#Load in data
load("SingleSpecies.RData")
#jags$recompile()
newModel<-F
```

#Abstract

```{r}
mdat<-read.csv("InputData/FullData-550793189439001813.csv")

##need to look into making into a movebank object.

#Create a oceandepth in km 
mdat$ocean<-round(mdat$ETOPO1.Elevation * -1 /1000,3)

mdat$coast<-round(mdat$NASA.Distance.to.Coast/1000,3)

#standardize column names to match the simulation
#Create an animal tag.
mxy <- as(mdat, "data.frame")
mxy$Animal<-mxy$individual.local.identifier
mxy$x<-mxy$location.long
mxy$y<-mxy$location.lat

#grab set of animals
#mxy<-mxy[mxy$Animal %in% c("112703","121211","131132","112737","131156","12326","123232","112705","154187","121210","131134","131141","112701","131159","131142","131144"),]

#mxy<-mxy[mxy$Animal %in% c("131132","131156","121211"),]
mxy$Animal<-as.numeric(as.factor(mxy$Animal))

#crop by extent
#crop by extent
d<-SpatialPointsDataFrame(cbind(mxy$x,mxy$y),data=mxy)
d<-crop(d,y=extent(c(-70,-55,-66,-58)))

mxy<-as.data.frame(d)
#set datestamp
mxy$timestamp<-as.POSIXct(mxy$timestamp,format="%Y-%m-%d %H:%M:%S.000")

#remove empty timestamps
mxy<-mxy[!is.na(mxy$timestamp),]
```

#Descriptive Statistics
```{r}
#no distance to coast,elevation
mxy<-mxy[!mxy$ETOPO1.Elevation>0,]
```

```{r}
#Plot
pp<-c(mean(mxy$x),mean(mxy$y))
m <- get_map(location=pp,source="google",zoom=5,scale=2,maptype="satellite")
ggmap(m)+geom_path(data=mxy, aes(x=x, y=y,col=as.factor(Animal)),size=.5) + labs(col="Whale")
```

##Distance

```{r,fig.height=3}
moved<-move(x=mxy$x,y=mxy$y,time=as.POSIXct(mxy$timestamp),proj=CRS("+proj=longlat +ellps=WGS84"),animal=mxy$Animal,data=as.data.frame(mxy),sensor=mxy$Animal,removeDuplicatedTimestamps=T)
dstat<-melt(move::distanceSummary(moved))

dstat<-droplevels(dstat[dstat$variable %in% c("TravDist","AverDist","FarthDist"),])
levels(dstat$variable)<-c("Total Distance","Average Distance Between Points","Farthest Distance Between Points")
ggplot(dstat,aes(value/1000)) + geom_histogram() + facet_wrap(~variable,scales="free") + labs(x="Kilometers")
```

##Time 
```{r,fig.height=3}
tstat<-move::timeSummary(moved)
tstat<-melt(tstat,measure.vars=colnames(tstat[[1]]))
tstat<-droplevels(tstat[tstat$variable %in% c("Duration","AverDur"),])
levels(tstat$variable)<-c("Total Time (Hours)","Average Time Between Points (Hours)")
ggplot(tstat,aes(value)) + geom_histogram() + facet_wrap(~variable,scales="free")
```

##Velocity
```{r,fig.height=3}
vstat<-move::speedSummary(moved)
vstat<-melt(vstat,measure.vars=colnames(vstat[[1]]))
levels(vstat$variable)<-c("Average Speed (m/s)","Variance in Speed (m/s)","Max Speed (m/s)")
ggplot(vstat,aes(value)) + geom_histogram() + facet_wrap(~variable,scales="free")
```

##Angles

```{r,fig.height=2}
astat<-move::angleSummary(moved)
astat<-melt(astat,measure.vars=colnames(astat[[1]]))
astat<-droplevels(astat[astat$variable %in% "AverAzimuth",])
levels(astat$variable)<-"Turning Angle (degrees)"
ggplot(astat,aes(value)) + geom_histogram() + facet_wrap(~variable,scales="free")
```

#Correlated random walk

*Process Model*

$$ d_{t} \sim T*d_{t-1} + Normal(0,\Sigma)$$
$$ x_t = x_{t-1} + d_{t} $$

## Parameters

For each individual:

$$\theta = \text{Mean turning angle}$$
$$\gamma = \text{Move persistence} $$

For both behaviors process variance is:
$$ \sigma_{latitude} = 0.1$$
$$ \sigma_{longitude} = 0.1$$

##Behavioral States

$$ \text{For each individual i}$$
$$ Behavior_1 = \text{traveling}$$
$$ Behavior_2 = \text{foraging}$$

$$ \alpha_{i,1,1} = \text{Probability of remaining traveling when traveling}$$
$$\alpha_{i,2,1} = \text{Probability of switching from feeding to traveling}$$

$$\begin{matrix}
  \alpha_{i,1,1} & 1-\alpha_{i,1,1} \\
  \alpha_{i,2,1} & 1-\alpha_{i,2,1} \\
\end{matrix}
$$

##Environment

Behavioral states are a function of local environmental conditions. The first environmental condition is ocean depth. I then build a function for preferential foraging in shallow waters.

It generally follows the form, conditional on behavior at t -1:

$$Behavior_t \sim Multinomial([\phi_{traveling},\phi_{foraging}])$$
$$logit(\phi_{traveling}) = \alpha_{Behavior_{t-1}} + \beta_1 * Ocean_{y[t,]}$$
$$logit(\phi_{foraging}) = \alpha_{Behavior_{t-1}} + \beta_2 * Ocean_{y[t,]}$$

```{r,fig.height=3,fig.width=3.5}
dplot<-function(a1,beta,beta2=0,x,coast=0){
  y<-inv.logit(a1[1]+beta[1]*x + beta2*coast)
  d11<-data.frame(x,y,State="Traveling",Begin="Traveling")
  
  y<-1-inv.logit(a1[1]+beta[1]*x+ beta2*coast)
  d12<-data.frame(x,y,State="Feeding",Begin="Traveling")

  y<-inv.logit(a1[2]+beta[2]*x+ beta2*coast)
  d21<-data.frame(x,y,State="Traveling",Begin="Feeding")
  
  y<-1-inv.logit(a1[2]+beta[2]*x+ beta2*coast)
  d22<-data.frame(x,y,State="Feeding",Begin="Feeding")
  
  d<-rbind_all(list(d11,d12,d21,d22))
}
```

##Continious tracks

The transmitter will often go dark for 10 to 12 hours, due to weather, right in the middle of an otherwise good track. The model requires regular intervals to estimate the turning angles and temporal autocorrelation. As a track hits one of these walls, call it the end of a track, and begin a new track once the weather improves. We can remove any micro-tracks that are less than three days.
Specify a duration, calculate the number of tracks and the number of removed points. Iteratively.

```{r}

##Time is the beginning of the first point.
step_length=6

sxy<-split(mxy,mxy$Animal)

#time diff function
timed<-function(d,step_length){
  d$j[1]<-0
  for (x in 2:nrow(d)){
    d$j[x]<-as.numeric(difftime(as.POSIXct(d$timestamp[x]),as.POSIXct(d$timestamp[x-1]),units="mins"))/(step_length*60)
  }
  
  #Split out track endings
  ends<-c(1,which(d$j>1),nrow(d))

  for(w in 2:length(ends)){
    d[ends[w-1]:ends[w],"Track"]<-w-1
  }
  
  #remove tracks that are shorter than three days
  track_time<-d %>% group_by(Track) %>% summarize(mt=difftime(max(as.POSIXct(timestamp)),min(as.POSIXct(timestamp)),units="days")) %>% filter(mt>=2) %>% .$Track

  
  d<-d[d$Track %in% track_time,]
  
  #renumber the tracks
  d$Track<-as.numeric(as.factor(d$Track))
  return(d)
  }

sxy<-lapply(sxy,timed,step_length=6)

#Format matrices for jags
mxy<-rbind_all(sxy)

######recode whales
mxy$Animal<-as.numeric(as.factor(mxy$Animal))

sxy<-split(mxy,list(mxy$Animal,mxy$Track),drop=TRUE)

sxy<-lapply(sxy,function(x){
#How many observations in each step length segment
x$Step<-as.numeric(cut(as.POSIXct(x$timestamp),"6 hours"))
return(x)
})

mxy<-rbind_all(sxy)
```

```{r}
#total number of steps per track/animal
steps_all<-mxy %>% group_by(Animal,Track) %>% summarize(n=length(unique(Step)))

# give each step a label
mxy<-mxy %>% group_by(Animal,Track,Step) %>% mutate(jStep=1:n())

#Cast time array
j<-acast(mxy,Animal~Track~Step~jStep,value.var="j")

#how many observations per individual in each Step
mxy$Step<-factor(mxy$Step,levels=1:max(steps_all$n))
idx<-melt(table(mxy$Animal,mxy$Track,mxy$Step))
colnames(idx)<-c("Animal","Track","Step","jStep")
idx<-acast(data=idx,Animal~Track~Step)

#make ocean a matrix -> MEAN VALUE -> will this yield a jags error on empty cells?
oc<-acast(mxy,Animal~Track~Step,value.var="ocean",fun.aggregate = mean)

#make coast a matrix -> MEAN VALUE -> will this yield a jags error on empty cells?
coast<-acast(mxy,Animal~Track~Step,value.var="coast",fun.aggregate = mean)

#Individuals
ind=length(unique(mxy$Animal))

#tracks per indivudal
tracks<-mxy %>% group_by(Animal) %>% summarize(tracks=length(unique(Track))) %>% .$tracks

#steps per track
steps<-acast(steps_all,Animal~Track,value.var="n")

#obs array
obs<-melt(mxy,measure.vars=c("x","y"))
obs<-acast(obs,Animal~Track~Step~jStep~variable)

```

How did the filter change the extent of tracks?

```{r}
#Plot
mxy<-mxy %>% arrange(Animal,Track,Step,jStep)

pp<-c(mean(mxy$x),mean(mxy$y))
m <- get_map(location=pp,source="google",zoom=5,scale=2,maptype="satellite")
ggmap(m)+geom_path(data=mxy, aes(x=x, y=y,col=as.factor(Animal)),size=.5) + labs(col="Whale")
```

```{r,fig.height=3,fig.width=5}
ggplot(data=steps_all,aes(x=n*step_length/24)) + geom_histogram() + labs(x="Days") + ggtitle("Track Length")
ggplot(data=steps_all,aes(x=Track)) + geom_histogram() + labs(x="Subtracks per Animal")
```

```{r,child="Bayesian/MultiSpecies.R",eval=T}
```

```{r,eval=T}
#source jags file
source("Bayesian/MultiSpecies.R")

#prior cov shape
R <- diag(c(1,1))
data=list(argos=obs,steps=steps,R=R,ocean=oc,coast=coast,ind=ind,j=j,idx=idx,tracks=tracks)

#paramters to track
pt<-c("theta","gamma","phi","alpha_mu","beta_mu","beta2_mu","state")

if(newModel){
  system.time(jagM<-jags.parallel(model.file = "Bayesian/Multi_RW.jags",data=data,n.chains=2,parameters.to.save=pt,n.iter=20000,n.burnin=18000,n.thin=4,DIC=FALSE))
}
save.image("SingleSpecies.RData")
```

##Chains
```{r,fig.height=10}
#bind chains
pc<-melt(jagM$BUGSoutput$sims.array)
colnames(pc)<-c("Draw","chain","par","value")

#extract parameter name
pc$parameter<-data.frame(str_match(pc$par,"(\\w+)"))[,-1]

#Extract index
splitpc<-split(pc,pc$parameter)

#single index
splitpc[c("alpha_mu","beta_mu","gamma","theta")]<-lapply(splitpc[c("alpha_mu","beta_mu","gamma","theta")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,Behavior=sv)
    return(pc)
})

#State index
splitpc[c("state")]<-lapply(splitpc[c("state")],function(x){
    #As matrices
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+),(\\d+),(\\d+)]"))[,3:5]
    colnames(sv)<-c("Animal","Track","step")
    pc<-data.frame(x,sv)
})

#Three index
splitpc[c("phi")]<-lapply(splitpc[c("phi")],function(x){
#As matrices
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+),(\\d+),(\\d+),(\\d+)]"))[,3:6]
    colnames(sv)<-c("Animal","Track","step","Behavior")
    pc<-data.frame(x,sv)
})

#bind all matrices back together
pc<-rbind_all(splitpc)
rm(splitpc)

#plot all but phi and state
ggplot(pc[!pc$parameter %in% c("phi","state"),],aes(x=Draw,y=value)) + facet_wrap(~par,scales="free",ncol=2) + geom_line(aes(col=as.factor(chain))) + labs(col="Chain")

```

```{r,fig.width=11}
#Plot
ggplot(data=pc[!pc$parameter %in% c("phi","state"),],aes(x=value)) + geom_histogram() + facet_wrap(~par,scales='free',ncol=4) + theme_bw()  + ggtitle("Estimated parameters")
```

###Compare to priors

```{r}
#add comparison to priors
todraw<-table(pc$par)[1]
pc$Estimate<-"Posterior"

#add priors
#alpha
a1prior<-data.frame(Draw=1:todraw,par='alpha[1]',value=rnorm(todraw,0,1.67),parameter='alpha_mu',Behavior=1,Estimate="Prior")

a2prior<-data.frame(Draw=1:todraw,par='alpha[2]',value=rnorm(todraw,0,1.67),parameter='alpha_mu',Behavior=2,Estimate="Prior")

beta1prior<-data.frame(Draw=1:todraw,par='beta[1]',value=rnorm(todraw,0,1.67),parameter='beta_mu',Behavior=1,Estimate="Prior")

beta2prior<-data.frame(Draw=1:todraw,par='beta[2]',value=rnorm(todraw,0,1.67),parameter='beta_mu',Behavior=2,Estimate="Prior")

beta21prior<-data.frame(Draw=1:todraw,par='beta2[1]',value=rnorm(todraw,0,1.67),parameter='beta2_mu',Behavior=1,Estimate="Prior")

beta22prior<-data.frame(Draw=1:todraw,par='beta2[2]',value=rnorm(todraw,0,1.67),parameter='beta2_mu',Behavior=2,Estimate="Prior")

gamma1prior<-data.frame(Draw=1:todraw,par='gamma[1]',value=rbeta(todraw,5,2),parameter='gamma',Behavior=1,Estimate="Prior")

gamma2prior<-data.frame(Draw=1:todraw,par='gamma[2]',value=rbeta(todraw,2,5),parameter='gamma',Behavior=2,Estimate="Prior")

prs<-rbind_all(list(a1prior,a2prior,beta1prior,beta2prior,beta21prior,beta22prior,gamma1prior,gamma2prior))

prs$Behavior<-as.factor(prs$Behavior)

allp<-rbind_all(list(pc[!pc$parameter %in% c("phi"),],prs))

ggplot(allp,aes(x=Behavior,y=value,fill=Estimate)) + geom_violin() + facet_wrap(~parameter,scale="free")
rm(allp)
```

##Prediction - environmental function

### Ocean Depth
```{r}
#get the posterior estimates of the env function

postplot<-pc %>% filter(parameter %in% c('beta_mu','alpha_mu')) %>% dcast(.,Draw+chain~par) %>% group_by(Draw,chain) %>% do(dplot(a1=c(.$'alpha_mu[1]',.$'alpha_mu[2]'),beta=c(.$'beta_mu[1]',.$'beta_mu[2]'),x=unique(mxy$ocean))) %>% group_by(x=x,Begin,State) %>% summarize(mean=mean(y),lower=quantile(y,0.05),upper=quantile(y,0.95))

#mean env estimate
ggplot(postplot) + geom_ribbon(aes(x=x,y=mean,ymin=upper,ymax=lower,fill=State),alpha=0.5) + theme_bw() + labs(col="Transition",x="Ocean Depth (km)",y="Probability",fill="Transition") + facet_wrap(~Begin) 
```

### Distance to Coast
```{r}
#get the posterior estimates of the env function

postplot<-pc %>% filter(parameter %in% c('beta2_mu','alpha_mu')) %>% dcast(.,Draw+chain~par) %>% group_by(Draw,chain) %>% do(dplot(a1=c(.$'alpha_mu[1]',.$'alpha_mu[2]'),beta=c(.$'beta2_mu[1]',.$'beta2_mu[2]'),x=unique(mxy$coast))) %>% group_by(x=x,Begin,State) %>% summarize(mean=mean(y),lower=quantile(y,0.05),upper=quantile(y,0.95))

#mean env estimate
ggplot(postplot) + geom_ribbon(aes(x=x,y=mean,ymin=upper,ymax=lower,fill=State),alpha=0.5) + theme_bw() + labs(col="Transition",x="Distance to Coast (km)",y="Probability",fill="Transition") + facet_wrap(~Begin) 
```

#Behavioral Prediction

```{r}
#We just need Feeding behavior
behav_chains<-pc[pc$Behavior == 2 & pc$parameter %in% "phi",]

#arrange by time - capitalize
behav_chains$Step<-as.numeric(as.character(behav_chains$step))
behav_chains<-behav_chains %>% arrange(Step)

#Label Behaviors
behav_chains$Behavior<-as.factor(behav_chains$Behavior)
levels(behav_chains$Behavior)<-c("Traveling","Feeding")

#average phi
mean_phi<-behav_chains %>% group_by(Animal,Track,Step) %>% summarize(phi=mean(value))

mxy<-merge(mxy,mean_phi,by=c("Step","Track","Animal"))

#ensure order for plotting
mxy<-mxy %>% arrange(Animal,Track,Step,jStep)

rm(behav_chains)
```

##Spatial Prediction

### Per Animal
```{r}
sxy<-split(mxy,mxy$Animal)
spp<-lapply(sxy,function(x){
  pp<-bbox(cbind(x$x,x$y))
  m <- get_map(location=pp,zoom=6,source="google",scale=1,maptype="satellite")
  ggmap(m)+geom_path(data=x, aes(x=x, y=y,col=phi),size=.5)   + scale_color_continuous(low='blue',high='red',limits=c(0,1)) + labs(col="Probability of Feeding") + facet_wrap(~Animal) + theme_bw()
})
spp

```

##Log Odds of Feeding

### Ocean Depth

```{r,fig.height=10}
#phi and ocean plot
ggplot(data=mxy,aes(x=ocean,y=logit(phi))) + geom_point() + labs(x="Ocean Depth",y="Estimated Log Odds of Feeding") + facet_wrap(~Animal,ncol=4)
```

### Distance From Coast

```{r,fig.height=10}
#phi and ocean plot
ggplot(data=mxy,aes(x=coast,y=logit(phi))) + geom_point() + labs(x="Distance to coast",y="Estimated Log Odds of Feeding") + facet_wrap(~Animal,ncol=4)
```

###Interaction

No estimate of uncertainty.
```{r}
coastx<-seq(0,quantile(mxy$coast,0.95),quantile(mxy$coast,0.95)/20)
oceanx<-seq(0,quantile(mxy$ocean,0.95),quantile(mxy$ocean,0.95)/20)
allx<-expand.grid(coastx,oceanx)
colnames(allx)<-c("coast","ocean")
allx$ID<-1:nrow(allx)
allx$alpha<-filter(pc,par %in% 'alpha_mu[1]') %>% group_by(parameter) %>% summarize(m=mean(value)) %>% .$m
allx$beta1<-filter(pc,par %in% 'beta_mu[2]') %>% group_by(parameter) %>% summarize(m=mean(value)) %>% .$m
allx$beta2<-filter(pc,par %in% 'beta2_mu[2]') %>% group_by(parameter) %>% summarize(m=mean(value)) %>% .$m

traj<-function(ocean,coast,alpha,beta1,beta2){
  p<-inv.logit(alpha + beta1*ocean + beta2*coast)
  data.frame(ocean,coast,phi=p)
}

intplot<-allx %>% group_by(ID) %>% do(traj(.$ocean,.$coast,.$alpha,.$beta1,.$beta2))

ggplot(intplot,aes(x=ocean,y=coast,fill=phi)) + geom_tile() + theme_bw() + labs(x="Ocean Depth (km)",y="Distance to coast (km)") + scale_fill_gradient(low="blue",high="red") + ggtitle("Mean Probability of Feeding when Traveling")
```

##Autocorrelation in behavior

```{r,fig.height=20,fig.width=13}
#create proper time stamp
ggplot(data=mxy,aes(x=as.POSIXct(timestamp),y=phi,col=ocean)) + geom_line(aes(group=Track),size=2.5) + labs("Probability of Feeding") + theme_bw() + scale_color_continuous(low='light blue',high='black') + labs(x="Time",y="Liklihood of Feeding") + facet_wrap(~Animal,ncol=3,scales="free") + ylim(0,1)
```

##Behavioral description

## Predicted behavior duration
```{r,fig.height=5,fig.width=14}
runf<-function(x){
  #arrange by step
  #calculate run length
  state_change<-rle(as.numeric(x$value))
  runl<-data.frame(Animal=unique(x$Animal),runs=state_change$lengths,Behavior=state_change$values)
  runl$Behavior<-as.factor(runl$Behavior)
  levels(runl$Behavior)<-c("Traveling","Feeding")
  
  return(runl)
}

runs<-pc %>% filter(parameter=='state') %>% group_by(Animal,Draw,chain) %>% do(runf(.))


#turn steps to hours
runs$hours<-runs$runs*step_length
ggplot(runs,aes(x=as.numeric(hours),fill=Behavior)) + geom_histogram(position='dodge') + scale_x_continuous(breaks=seq(0,max(runs$hours),by=48)) + labs(x="Hours") + ggtitle("Predicted Behavior Duration") + theme_bw()
```

```{r,fig.height=3,fig.with=3.5}
mr<-runs %>% group_by(Behavior) %>% summarize(mean=mean(hours),lower=quantile(runs,0.05),upper=quantile(runs,0.95))
ggplot(mr,aes(x=Behavior,y=mean,ymin=lower,ymax=upper)) + geom_pointrange(size=2) + theme_bw() + ggtitle("Average Duration of Behavior") + labs(y="Hours")

#Every run eventually ends in a switch (that's what makes it a run)
runs$status<-1

endtrack<-function(x){
  x[nrow(x),"status"]<-0
  return(x)
}

#if track ends, status is 0 not 1
feedr<-runs %>% group_by(Draw,chain,Animal) %>% do(endtrack(.)) %>% filter(Behavior=="Feeding")

#save runs to file
write.csv(feedr,"OutData/Runs.csv")
```

##Location of Behavior

```{r}
msp<-SpatialPointsDataFrame(cbind(mxy$x,mxy$y),data=mxy[,c("x","y","Animal","phi","timestamp")],proj=CRS("+proj=longlat +datum=WGS84"))

r<-raster(msp,ext=extent(c(-70,-55,-66,-58)))
res(r)<-0.1

m<-rasterize(x=msp,y=r,field="phi")

#plotting
feedmap <- data.frame(rasterToPoints(m))

temp <- get_map(location=bbox(m),source="google",zoom=5,maptype="satellite",color = "bw",scale = 2)

ggmap(temp) + labs(fill="Probabilty of Feeding")+ geom_tile(data=feedmap,aes(x=x, y=y,fill=layer),alpha=0.9) + theme_minimal() + scale_color_discrete(guide="none") + scale_fill_continuous(low="blue",high="red")
```


#Krill Fishery
```{r}
krill<-read.csv("InputData/CCAMLR_aggregated_catch_C1.csv")
# krill<-SpatialPointsDataFrame(cbind(krill$GridMidpointDegreeLon,krill$GridMidpointDegreeLat),data=krill)
# 
# k<-points2grid(krill)
# r<-rasterize(krill,raster(k),"C1KRIcatchKG")

#as data frames

ggmap(temp) + geom_tile(data=feedmap,aes(x=x, y=y,fill=layer),alpha=0.7) + geom_point(data=krill,aes(x=GridMidpointDegreeLon,y=GridMidpointHalfDegreeLat,size=C1KRIcatchKG)) + scale_fill_continuous(low="blue",high="red") + scale_color_continuous(low="white",high="black") + labs(fill="Probability of Feeding", size="Krill Catch") + scale_size_continuous(range=c(0,8)) 
```

```{r}
#notify end of run
#size of the run
gc()
save.image("SingleSpecies.RData")
```
