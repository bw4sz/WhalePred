---
title: "Mapping"
author: "Ben Weinstein"
date: "April 22, 2016"
output: 
  html_document:
  keep_md: True
  numbered_sections: True
  toc: true
  theme: spacelab
---

```{r,warning=FALSE,message=FALSE,echo=FALSE}
library(knitr)
opts_chunk$set(echo=F,warning=F,message=F,fig.width = 10,fig.height = 5)

library(sp)
library(dismo)
library(raster)
library(reshape2)
library(ggplot2)
library(dplyr)
library(chron)
library(moveHMM)
library(move)
library(ggmap)
library(gridExtra)
```

#Read in data

```{r}
dat<-read.csv("InputData/ArgosData_2016_03_14_22_54_50.csv")

#Create move object

#Time stamp
dat$TimeStamp<-as.POSIXct(dat$Msg.Date,format="%d/%m/%Y  %H:%M",tz="GMT")

#Need to remove duplicated timestamp?
ddat<-dat %>% group_by(Platform.ID.No.,TimeStamp) %>% distinct() %>% arrange(TimeStamp)

#sort time objects
mdat<-move(x=ddat$Latitude,y=ddat$Longitude,time=ddat$TimeStamp,proj=CRS("+proj=longlat +ellps=WGS84"),animal=ddat$Platform.ID.No.)
```

#Summary statistics

## Number of locations
```{r}
n.locs(mdat)
```

## Time lag

```{r}
tm<-melt(timeLag(mdat,units="mins"))
ggplot(tm,aes(x=value,fill=L1)) + geom_histogram() + facet_wrap(~L1,scales='free') + ggtitle("Time Lag") + xlab("Minutes") + theme_bw()
```

## Derived movement statistics
```{r,fig.height=6,fig.width=8}
mss<-melt(summary(mdat))
ggplot(mss,aes(x=L1,y=value,col=L1)) + geom_point() + facet_wrap(~variable,scales="free") + ggtitle("Average Movement") + xlab("Individual") + theme_bw() + theme(axis.text.x = element_blank())

```

#Visualize Tracks

## Overall
```{r}
mdat_df <- as(mdat, "data.frame")
m <- get_map(bbox(extent(mdat)*1.1), source="google", zoom=4,maptype = 'terrain')
ggmap(m)+geom_path(data=mdat_df, aes(x=x, y=y,col=trackId))
```

## Individual tracks

```{r}
sdat<-split(mdat_df,mdat_df$trackId)
p<-lapply(sdat,function(j){
  m <- get_map(bbox(extent(mdat[mdat@trackId %in% j$trackId])*1.1), source="google",zoom=7,scale=2,maptype="terrain")
  p<-ggmap(m)+geom_path(data=j, aes(x=x, y=y),size=0.5,col='red',linetype='dashed')  + theme_inset()
})
p
```

#Utilization Distribution

```{r}
sptrans_mdat<-spTransform(mdat[mdat@trackId %in% j$trackId],center=T)
mm1<-brownian.bridge.dyn(sptrans_mdat,dimSize=150,location.error = 20)
plot(mm1)
```
